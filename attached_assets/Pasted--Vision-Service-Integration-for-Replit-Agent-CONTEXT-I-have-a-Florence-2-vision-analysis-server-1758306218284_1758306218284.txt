# Vision Service Integration for Replit Agent

## CONTEXT
I have a Florence-2 vision analysis server running locally on my PC that's exposed via LocalTunnel. I need you to help me integrate this vision service into my Replit application.

## VISION SERVER DETAILS

**Server URL:** `https://elitevision.loca.lt`
**Model:** Microsoft Florence-2 (advanced vision-language model)
**Status:** Currently running and accessible

### API Endpoints Available:

1. **Health Check:**
   - `GET https://elitevision.loca.lt/test`
   - Returns: `{"status": "Server is running!"}`

2. **Image Analysis:**
   - `POST https://elitevision.loca.lt/analyze`
   - Content-Type: `application/json`
   - Body format:
   ```json
   {
     "image": "base64_encoded_image_string",
     "prompt": "optional_custom_prompt_here"
   }
   ```
   - Returns:
   ```json
   {
     "caption": "detailed_image_description",
     "model": "florence-2",
     "timestamp": "ISO_timestamp",
     "metadata": {}
   }
   ```

## CURRENT IMPLEMENTATION

I already have this TypeScript interface and test function:

```typescript
interface CustomVisionOptions {
  prompt?: string;
}

interface CustomVisionResult {
  caption: string;
  model: string;
  timestamp: string;
  metadata?: any;
}

const VISION_SERVER_URL = "https://elitevision.loca.lt/";

export async function testCustomVisionServer(): Promise<{ isOnline: boolean; details?: any; error?: string }> {
  try {
    const response = await axios.get(`${VISION_SERVER_URL}/test`, {
      timeout: 5000,
      headers: {
        'ngrok-skip-browser-warning': 'true'
      }
    });
    
    if (response.status === 200) {
      return { isOnline: true, details: response.data };
    } else {
      return { isOnline: false, error: `Server returned status ${response.status}` };
    }
  } catch (error: any) {
    return { 
      isOnline: false, 
      error: error.code === 'ECONNABORTED' ? 'Connection timeout' : error.message 
    };
  }
}
```

## WHAT I NEED YOU TO DO

### 1. **Create Image Analysis Function**
Build a complete `analyzeImageWithCustomVision()` function that:
- Takes an image file or base64 string as input
- Converts to base64 if needed
- Sends proper POST request to `/analyze` endpoint
- Handles errors gracefully
- Returns the vision analysis results

### 2. **Error Handling & Fallbacks**
Implement robust error handling for:
- Network timeouts
- Server unavailable
- Invalid image formats
- Rate limiting
- Malformed responses

### 3. **Integration Examples**
Show me how to:
- Upload an image file and analyze it
- Analyze images from URLs
- Use custom prompts for specific analysis tasks
- Display results in the UI

### 4. **Testing & Validation**
Create test functions to:
- Verify server connectivity
- Test image analysis with sample images
- Validate response format
- Performance benchmarking

### 5. **Type Safety**
Ensure proper TypeScript typing for:
- Request/response interfaces
- Error types
- Image input types (File, string, base64, etc.)

## TECHNICAL REQUIREMENTS

- **Framework:** Works in Replit's environment
- **HTTP Library:** Use axios (already imported)
- **Image Handling:** Support File objects, base64 strings, and URLs
- **Error Recovery:** Graceful degradation if vision server is unavailable
- **Performance:** Efficient base64 conversion and request handling

## EXPECTED CAPABILITIES

After integration, I should be able to:
- ✅ Upload any image and get detailed AI analysis
- ✅ Use custom prompts like "What emotions are visible?" or "Describe the technical details"
- ✅ Handle multiple image formats (JPEG, PNG, WebP, etc.)
- ✅ Get structured, parseable responses
- ✅ Have reliable error handling and user feedback

## SAMPLE USE CASES

1. **Basic Analysis:** "Analyze this uploaded image"
2. **Custom Prompts:** "What safety hazards do you see in this workplace photo?"
3. **Batch Processing:** Analyze multiple images in sequence
4. **Real-time:** Integrate with camera/webcam for live analysis

Please provide complete, production-ready code with proper error handling, TypeScript types, and clear documentation. Include examples of how to use each function you create.

## CURRENT STATUS
- ✅ Vision server running on my PC
- ✅ LocalTunnel exposing at https://elitevision.loca.lt
- ✅ Basic connectivity test working
- ❌ Need complete integration implementation